name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run MegaLinter
        uses: oxsecurity/megalinter@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload MegaLinter reports
        uses: actions/upload-artifact@v3
        with:
          name: megalinter-reports
          path: |
            megalinter-reports/
            mega-linter.log

  generate-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Generate build summary
        run: echo "Build summary generated!" > summary.txt

      - name: Upload summary
        uses: actions/upload-artifact@v3
        with:
          name: build-summary
          path: summary.txt

  update-argocd:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to ArgoCD
        run: echo "Deploying to ArgoCD..."

  notify-teams:
    runs-on: ubuntu-latest
    needs: [lint, generate-summary, update-argocd]
    steps:
      - name: Get artifact download URL
        run: |
          echo "Artifact URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" > artifact_url.txt

      - name: Send Teams Notification
        uses: mpetrunic/teams-notify-action@v1
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          message: "âœ… CI/CD Pipeline completed! \nðŸ”— [Download Reports and Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) \nðŸ‘¤ Triggered by: ${{ github.actor }}"
